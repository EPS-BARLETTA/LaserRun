<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LaserRun</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
 :root{
   --bg:#f4f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --primary:#0a58ff;
   --green:#22c55e; --amber:#f59e0b; --red:#ef4444; --violet:#7c3aed; --slate:#334155;
   --radius:16px; --ring:0 8px 40px rgba(2,6,23,.08);
   --panel1:#e8f1ff; --panel2:#e9fbe8; --band:#eef2f7;
 }
 *{box-sizing:border-box}
 /* === Structure page + footer fix√© bas === */
 body{
   margin:0;background:var(--bg);color:var(--ink);
   font:16px/1.4 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
   min-height:100vh; display:flex; flex-direction:column; padding-bottom:56px;
 }
 footer{
   position:fixed; left:0; right:0; bottom:0;
   border-top:1px solid #e5e7eb; color:var(--muted);
   text-align:center; padding:10px 0; background:#fff;
 }

 .shell{max-width:980px;margin:0 auto;padding:16px}
 h1{font-size:clamp(22px,3.4vw,32px);margin:8px 0 4px;font-weight:800;text-align:center}
 h2{font-size:clamp(20px,2.8vw,28px);margin:8px 0 12px;font-weight:800;text-align:center}
 h3{margin:0 0 10px;font-size:18px;text-align:center}
 p{margin:0 0 8px;text-align:center}
 .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--ring);padding:16px;margin:12px 0}
 .btns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
 button{border:0;border-radius:16px;padding:14px 18px;font-weight:800;cursor:pointer;font-size:18px}
 .b-primary{background:var(--primary);color:#fff}
 .b-green{background:var(--green);color:#fff}
 .b-amber{background:var(--amber);color:#111}
 .b-red{background:var(--red);color:#fff}
 .b-violet{background:var(--violet);color:#fff}
 .b-slate{background:var(--slate);color:#fff}
 .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
 .panel{border-radius:16px;padding:16px}
 .panel1{background:var(--panel1)}
 .panel2{background:var(--panel2)}
 .band{background:var(--band);border-radius:12px;padding:10px 12px;margin-top:16px;font-weight:700}
 label{display:block;font-weight:800;margin:10px 0 6px}
 input,select{width:100%;padding:14px 16px;border:2px solid #e5e7eb;border-radius:14px;background:#fff;font:inherit}
 input[type=number]{appearance:textfield}
 select{background:#fff}
 .muted{color:var(--muted)}
 .hidden{display:none!important}
 .center{text-align:center}
 .big{font-size:40px;font-weight:900}
 .xl{font-size:60px;font-weight:900}
 .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#eef2f7}
 table{width:100%;border-collapse:collapse}
 th,td{padding:12px;border-bottom:1px solid #e5e7eb;text-align:center;font-size:16px}
 .lock *{pointer-events:none; opacity:.7}
 .shot-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px}

 /* === Accueil centr√© verticalement === */
 #view-cover{min-height:calc(100vh - 56px); display:flex; align-items:center; justify-content:center;}
 .cover-stack{display:flex; flex-direction:column; gap:16px; align-items:center;}
 .substack{display:flex; gap:12px; flex-wrap:wrap; justify-content:center;}
 .tagline{color:var(--muted)}

 /* === Modales pro (Aide / Fiche s√©curit√© / Indice) === */
 .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50;
   background:linear-gradient(180deg,rgba(2,6,23,.55),rgba(2,6,23,.35));}
 .modal-card{background:#fff; border-radius:20px; max-width:900px; width:92%; overflow:hidden; box-shadow:0 12px 48px rgba(2,6,23,.25)}
 .modal-head{display:flex; align-items:center; gap:12px; padding:16px 18px; color:#fff; font-weight:800}
 .modal-head.help{background:linear-gradient(90deg,#0a58ff,#7c3aed)}
 .modal-head.safe{background:linear-gradient(90deg,#22c55e,#0ea5e9)}
 .modal-head.indice{background:linear-gradient(90deg,#111827,#0a58ff)}
 .modal-body{padding:18px}
 .modal-body h4{margin:12px 0 6px}
 .help-list{margin:8px 0 12px; line-height:1.55}
 .help-list li{margin:6px 0}

 /* === Gros bouton +1 tour (ergonomie iPad) === */
 #lapPlus{font-size:22px; padding:18px 26px; border-radius:22px; min-width:180px}
 #lapMinus{font-size:20px; padding:16px 22px; border-radius:20px}

 /* === OVERLAY fin de course (obligatoire) === */
 #endOverlay{
   position:fixed; inset:0; display:none; z-index:60;
   align-items:center; justify-content:center;
   background:rgba(2,6,23,.55);
 }
 #endOverlay.show{display:flex;}
 .end-card{
   background:#fff; border-radius:20px; padding:20px; width:min(720px,92%);
   box-shadow:0 12px 48px rgba(2,6,23,.25); text-align:center;
 }
 .end-card h3{margin-top:0}
 .end-note{color:var(--muted); margin-top:8px}

 /* === Mode Prof (√©dition) === */
 .prof-tools{max-width:720px;margin:12px auto}
 .prof-row{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap}
 .prof-row input{padding:10px 12px; border:2px solid #e5e7eb; border-radius:12px; font:inherit; width:160px}
 .prof-on td[contenteditable="true"]{outline:2px dashed #0a58ff; background:#edf2ff}
</style>
</head>
<body>
 <!-- ===== Page de garde (centr√©e) ===== -->
 <main class="shell" id="view-cover">
   <section class="card center" style="padding:28px 20px">
     <div class="cover-stack">
       <div>
         <h1>LaserRun</h1>
         <p class="tagline">Application EPS ‚Äî compatible ScanProf</p>
       </div>
       <!-- D√©marrer (seul) -->
       <div class="btns" style="margin-top:12px">
         <button class="b-primary" id="btnStart">‚ñ∂Ô∏è D√©marrer</button>
       </div>
       <!-- Aide + Fiche s√©curit√© en dessous -->
       <div class="substack">
         <button class="b-slate" id="btnHelp">‚ÑπÔ∏è Aide</button>
         <button class="b-amber" id="btnSafety">üõü Fiche s√©curit√©</button>
       </div>
     </div>
   </section>
 </main>

 <!-- ===== Modale Aide ===== -->
 <div class="modal hidden" id="modalHelp">
   <div class="modal-card">
     <div class="modal-head help"><span>‚ÑπÔ∏è</span><span>Mode d'emploi ‚Äî LaserRun</span></div>
     <div class="modal-body">
       <p class="muted">Guide rapide pour utiliser l‚Äôapplication en cours d‚ÄôEPS.</p>
       <ol class="help-list">
         <li>Renseigner pour chaque coureur : <strong>Pr√©nom</strong>, <strong>Nom</strong>, <strong>Classe</strong>, <strong>Sexe</strong>.</li>
         <li>D√©finir les param√®tres communs : <strong>Dur√©e (min)</strong> et <strong>Longueur du tour (m)</strong>.</li>
         <li>Dans la course : <strong>Start/Pause</strong> le chrono, <strong>+1 / ‚àí1</strong> pour les tours (distance en direct).</li>
         <li>Au tir : saisir le <strong>nombre de LED allum√©es (0‚Äì5)</strong>. Les cumuls ‚ÄúNb LED ‚Ä¶‚Äù s‚Äôactualisent sous les boutons.</li>
         <li>En fin de temps : compl√©ter la <strong>fraction de tour</strong>, terminer chaque coureur, puis g√©n√©rer le <strong>QR</strong> (ScanProf).</li>
       </ol>
       <div class="btns"><button class="b-slate" data-close>Fermer</button></div>
     </div>
   </div>
 </div>

 <!-- ===== Modale Fiche s√©curit√© ===== -->
 <div class="modal hidden" id="modalSafety">
   <div class="modal-card">
     <div class="modal-head safe"><span>üõü</span><span>Fiche s√©curit√© ‚Äî LaserRun</span></div>
     <div class="modal-body">
       <h4>Avant l‚Äôactivit√©</h4>
       <ul class="help-list">
         <li>V√©rifier le trac√©, la stabilit√© et le d√©gagement de la zone de tir.</li>
         <li>Contr√¥ler le mat√©riel laser (fonctionnement, fixations).</li>
         <li>√âchauffement complet ; chaussures adapt√©es et lac√©es.</li>
       </ul>
       <h4>Pendant l‚Äôactivit√©</h4>
       <ul class="help-list">
         <li>Calme au pas de tir ; attendre le signal ; respecter les consignes.</li>
         <li>Attention aux croisements course ‚Üî tir ; gestion des flux.</li>
         <li>Signaler tout incident imm√©diatement √† l‚Äôenseignant.</li>
       </ul>
       <h4>Apr√®s l‚Äôactivit√©</h4>
       <ul class="help-list">
         <li>Retour au calme (marche, respiration), hydratation, rangement.</li>
       </ul>
       <div class="btns"><button class="b-slate" data-close>Fermer</button></div>
     </div>
   </div>
 </div>

 <!-- ===== Page Saisie 2 √©l√®ves (inchang√©e) ===== -->
 <main class="shell hidden" id="view-duo">
   <section class="card">
     <h2>Saisie des informations</h2>
     <p class="muted">Identit√© des deux coureurs + param√®tres de course communs.</p>
     <div class="row">
       <div class="panel panel1">
         <h3>COUREUR 1</h3>
         <label>Pr√©nom</label>
         <input id="p1_prenom" maxlength="60" autocomplete="off"/>
         <label>Nom</label>
         <input id="p1_nom" maxlength="60" autocomplete="off"/>
         <label>Classe</label>
         <input id="p1_classe" maxlength="60" autocomplete="off"/>
         <label>Sexe</label>
         <select id="p1_sexe">
           <option value="">‚Äî</option>
           <option>F</option>
           <option>M</option>
         </select>
       </div>
       <div class="panel panel2">
         <h3>COUREUR 2</h3>
         <label>Pr√©nom</label>
         <input id="p2_prenom" maxlength="60" autocomplete="off"/>
         <label>Nom</label>
         <input id="p2_nom" maxlength="60" autocomplete="off"/>
         <label>Classe</label>
         <input id="p2_classe" maxlength="60" autocomplete="off"/>
         <label>Sexe</label>
         <select id="p2_sexe">
           <option value="">‚Äî</option>
           <option>F</option>
           <option>M</option>
         </select>
       </div>
     </div>

     <div class="band">Param√®tres de course (communs)</div>
     <div class="row">
       <div>
         <label>Dur√©e (minutes)</label>
         <input id="duree_min" type="number" inputmode="numeric" min="1" step="1" placeholder="ex. 20"/>
       </div>
       <div>
         <label>Longueur d'un tour (m)</label>
         <input id="tour_m" type="number" inputmode="numeric" min="10" step="1" placeholder="ex. 200"/>
       </div>
     </div>

     <div class="btns" style="margin-top:18px">
       <button class="b-primary" id="goCourse" disabled>Acc√©der √† la course</button>
       <button class="b-slate" id="goHome">üè† Accueil</button>
     </div>
   </section>
 </main>

 <!-- ===== Page course : chrono + tours + tir ===== -->
 <main class="shell hidden" id="view-course">
   <section class="card center" id="courseCard">
     <div class="btns" style="margin-bottom:8px">
       <button class="b-slate" id="backToDuo">‚¨Ö Retour saisie</button>
       <span class="pill" id="courseMeta">‚Äî</span>
     </div>
     <h2 id="runnerTitle">Coureur ‚Äî </h2>
     <div class="btns" style="margin-bottom:6px">
       <button class="b-green" id="pickP1">üëü Coureur 1</button>
       <button class="b-green" id="pickP2">üëü Coureur 2</button>
     </div>

     <div class="card" style="max-width:720px;margin:0 auto 12px">
       <div class="xl" id="clock">00:00.0</div>
       <div class="btns" style="margin-top:8px">
         <button class="b-primary" id="btnStartCourse">‚ñ∂Ô∏è Start</button>
         <button class="b-amber" id="btnPause" disabled>‚è∏Ô∏è Pause</button>
         <button class="b-red" id="btnReset" disabled>‚Ü∫ R√©init.</button>
       </div>
       <p class="muted">Dur√©e cible : <strong id="target"></strong> min</p>
     </div>

     <div class="row" style="max-width:720px;margin:0 auto">
       <div class="card">
         <h3>üèÅ Tours</h3>
         <div class="big" id="laps">0</div>
         <p class="muted">1 tour = <span id="lapMeters">‚Äî</span> m</p>
         <p class="muted"><strong>Distance provisoire :</strong> <span id="liveDistance">0</span> m</p>
         <div class="btns">
           <button class="b-green" id="lapPlus">+1 tour</button>
           <button class="b-slate" id="lapMinus">‚àí1</button>
         </div>
       </div>
       <div class="card">
         <h3>üéØ Tir ‚Äî Nombre de LED allum√©es</h3>
         <!-- Gros boutons 0‚Äì5 uniquement -->
         <div class="shot-grid">
           <button class="b-slate" data-quick="0">0</button>
           <button class="b-slate" data-quick="1">1</button>
           <button class="b-slate" data-quick="2">2</button>
           <button class="b-slate" data-quick="3">3</button>
           <button class="b-slate" data-quick="4">4</button>
           <button class="b-slate" data-quick="5">5</button>
         </div>
         <!-- Cumuls NB LED sous les num√©ros -->
         <p class="muted" id="liveCounts" style="margin-top:10px"></p>
         <div style="overflow:auto;margin-top:8px">
           <table>
             <thead><tr><th>#</th><th>LED allum√©es</th><th>Action</th></tr></thead>
             <tbody id="shotsTable"></tbody>
           </table>
         </div>
       </div>
     </div>

     <div class="card hidden" id="endCard" style="max-width:720px;margin:12px auto 0">
       <h3>‚è±Ô∏è Temps √©coul√© ‚Äî compl√©ter la fraction de tour</h3>
       <div class="btns">
         <button class="b-slate" data-frac="0.25">+ 1/4 tour</button>
         <button class="b-slate" data-frac="0.5">+ 1/2 tour</button>
         <button class="b-slate" data-frac="0.75">+ 3/4 tour</button>
         <button class="b-green" id="finishRunner">‚úÖ Terminer la course</button>
       </div>
       <p class="muted" id="distanceOut">Distance: ‚Äî m</p>
     </div>

     <div class="btns hidden" id="toSummaryWrap" style="margin-top:12px">
       <button class="b-primary" id="goSummary">üìä Aller au bilan</button>
     </div>
   </section>
 </main>

 <!-- ===== OVERLAY Fin obligatoire ===== -->
 <div id="endOverlay" aria-modal="true" role="dialog">
   <div class="end-card">
     <h3>‚è≥ Temps √©coul√©</h3>
     <p class="muted">Compl√©ter la fraction de tour si besoin, puis valider la course.</p>
     <div class="btns" style="margin:10px 0 4px">
       <button class="b-slate" data-frac-overlay="0">+ 0</button>
       <button class="b-slate" data-frac-overlay="0.25">+ 1/4</button>
       <button class="b-slate" data-frac-overlay="0.5">+ 1/2</button>
       <button class="b-slate" data-frac-overlay="0.75">+ 3/4</button>
     </div>
     <p class="end-note" id="distanceOutOverlay">Distance: ‚Äî m</p>
     <div class="btns" style="margin-top:8px">
       <button class="b-green" id="finishRunnerOverlay">‚úÖ Terminer la course</button>
     </div>
   </div>
 </div>

 <!-- ===== Page Bilan / QR ===== -->
 <main class="shell hidden" id="view-summary">
   <section class="card center">
     <h2>Bilan ‚Äî QR compatible ScanProf</h2>
     <div class="btns" style="margin:8px 0 4px">
       <button class="b-slate" id="btnIndiceInfo">‚ÑπÔ∏è Indice tir</button>
     </div>
     <div id="qr" class="card" style="display:inline-block"></div>

     <!-- Outils Prof (code 57) -->
     <div class="card prof-tools">
       <div class="prof-row">
         <input id="profCode" type="password" inputmode="numeric" placeholder="Entrer code Prof (57)"/>
         <button class="b-slate" id="activateProf">üîì Activer mode Prof</button>
         <button class="b-amber" id="deactivateProf" disabled>üîí D√©sactiver</button>
         <button class="b-violet" id="applyEdits" disabled>üíæ Mettre √† jour QR/CSV</button>
         <button class="b-violet" id="exportCsv">‚¨áÔ∏è Export CSV</button>
       </div>
       <p class="muted" id="profHint" style="margin-top:8px"></p>
     </div>

     <!-- Tableau r√©capitulatif lisible/√©ditable -->
     <div id="resume"></div>

     <div class="btns" style="margin-top:8px">
       <button class="b-slate" id="backToCourse">‚¨Ö Retour course</button>
       <button class="b-green" id="backHome2">üè† Accueil</button>
     </div>
   </section>
 </main>

 <!-- ===== Modale Indice Tir ===== -->
 <div class="modal hidden" id="modalIndice">
   <div class="modal-card">
     <div class="modal-head indice"><span>‚ÑπÔ∏è</span><span>Indice de performance au tir</span></div>
     <div class="modal-body">
       <p><strong>Comment c‚Äôest calcul√© ?</strong></p>
       <p>Indice = moyenne des LED allum√©es (sur 100) <em>+ bonus</em> pour chaque tir parfait (5/5).</p>
       <ul class="help-list">
         <li>Plus tu allumes de LED en <strong>moyenne</strong>, plus l‚Äôindice est haut.</li>
         <li>Les <strong>5/5</strong> donnent un petit bonus. La <strong>r√©gularit√©</strong> reste la cl√©.</li>
       </ul>
       <p><strong>Ce que √ßa veut dire :</strong></p>
       <ul class="help-list">
         <li><b>80 et +</b> : excellent niveau de pr√©cision ‚úÖ</li>
         <li><b>60‚Äì79</b> : bon niveau üëç</li>
         <li><b>40‚Äì59</b> : en progr√®s üü®</li>
         <li><b>moins de 40</b> : √† travailler üî¥</li>
       </ul>
       <div class="btns"><button class="b-slate" data-close>Fermer</button></div>
     </div>
   </div>
 </div>

 <footer>
   <div>LaserRun - √âquipe EPS Lyc√©e Vauban - LUXEMBOURG - JB</div>
 </footer>

 <!-- QRCode lib (CDN l√©ger) -->
 <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

 <script>
 'use strict';
 // ===== helpers / navigation =====
 function qs(sel){ return document.querySelector(sel); }
 const V = { cover: qs('#view-cover'), duo: qs('#view-duo'), course: qs('#view-course'), summary: qs('#view-summary') };
 function show(name){ Object.values(V).forEach(v=>v.classList.add('hidden')); V[name].classList.remove('hidden'); window.scrollTo(0,0); }
 qs('#btnStart').onclick = ()=> show('duo');

 // Modales Aide & S√©curit√© & Indice (pro)
 function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
 function closeModals(){ document.querySelectorAll('.modal').forEach(m=>m.classList.add('hidden')); }
 document.getElementById('btnHelp').onclick = ()=> openModal('modalHelp');
 document.getElementById('btnSafety').onclick = ()=> openModal('modalSafety');
 document.getElementById('btnIndiceInfo').onclick = ()=> openModal('modalIndice');
 document.querySelectorAll('.modal [data-close]').forEach(b=> b.onclick = closeModals);
 document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModals(); });

 // prot√®ger Accueil / Retour si course en cours
 function confirmLeaveIfNeeded(){
   if(!session.finished && (session.laps>0 || session.shots.length>0 || elapsed>0)){
     return confirm('Quitter la course ? Les donn√©es non termin√©es pourraient √™tre perdues.');
   }
   return true;
 }
 qs('#goHome').onclick = ()=> { if(confirmLeaveIfNeeded()) show('cover'); };
 qs('#backToDuo').onclick = ()=> { if(confirmLeaveIfNeeded()) show('duo'); };

 // ===== Validation (pr√©sence obligatoire) =====
 function clean(s){ return (s||'').replace(/\s+/g,' ').trim(); }
 function hasValue(id){ return clean(document.getElementById(id).value).length>0; }
 function okNumber(v,min){ const n=+v; return Number.isFinite(n)&&n>=min; }
 function val(id){ return clean(document.getElementById(id).value); }

 function validate(){
   const fields=['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe'];
   let ok=true;
   fields.forEach(id=>{
     const el=document.getElementById(id);
     const good=hasValue(id);
     el.style.borderColor = good?'#e5e7eb':'#ef4444';
     ok = ok && good;
   });
   const okDur=okNumber(val('duree_min'),1);
   const okTour=okNumber(val('tour_m'),10);
   document.getElementById('duree_min').style.borderColor = okDur?'#e5e7eb':'#ef4444';
   document.getElementById('tour_m').style.borderColor = okTour?'#e5e7eb':'#ef4444';
   ok = ok && okDur && okTour;
   document.getElementById('goCourse').disabled = !ok;
   return ok;
 }
 ['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe','duree_min','tour_m']
   .forEach(id=>{ const el=document.getElementById(id); el.addEventListener('input',validate); el.addEventListener('change',validate); });

 const session={ p1:null, p2:null, tourM:0, dureeMin:0, active:'p1',
   laps:0, frac:0, shots:[], results:{p1:null,p2:null}, finished:false };

 // Acc√®s course
 qs('#goCourse').onclick = ()=>{
   if(!validate()) { alert('Compl√©tez tous les champs (obligatoires) et v√©rifiez les nombres.'); return; }
   session.p1={ prenom:val('p1_prenom'), nom:val('p1_nom'), classe:val('p1_classe'), sexe:val('p1_sexe') };
   session.p2={ prenom:val('p2_prenom'), nom:val('p2_nom'), classe:val('p2_classe'), sexe:val('p2_sexe') };
   session.dureeMin=+val('duree_min'); session.tourM=+val('tour_m');
   session.active='p1'; resetRunnerState(); paintCourseHeader(); show('course');
 };

 // ===== Course =====
 const clockEl=qs('#clock'), lapsEl=qs('#laps'), lapMetersEl=qs('#lapMeters'), targetEl=qs('#target');
 const shotsTable=qs('#shotsTable'), runnerTitle=qs('#runnerTitle'), courseMeta=qs('#courseMeta');
 const endCard=qs('#endCard'), distanceOut=qs('#distanceOut'), courseCard=qs('#courseCard');
 const toSummaryWrap=qs('#toSummaryWrap');
 const liveDistanceEl=qs('#liveDistance');

 qs('#pickP1').onclick=()=> switchRunner('p1');
 qs('#pickP2').onclick=()=> switchRunner('p2');
 qs('#lapPlus').onclick=()=>{ if(session.finished) return; session.laps++; renderLaps(); };
 qs('#lapMinus').onclick=()=>{ if(session.finished) return; session.laps=Math.max(0,session.laps-1); renderLaps(); };

 document.querySelectorAll('[data-quick]').forEach(btn=>{
   btn.onclick=()=>{ if(session.finished) return; const v=+btn.getAttribute('data-quick'); addShot(v); };
 });

 let t0=0, elapsed=0, timer=null, running=false;
 function start(){ if(session.finished||running) return; running=true; t0=Date.now()-elapsed; timer=setInterval(tick,100); qs('#btnStartCourse').disabled=true; qs('#btnPause').disabled=false; qs('#btnReset').disabled=false; }
 function pause(){ if(!running) return; running=false; clearInterval(timer); qs('#btnStartCourse').disabled=false; qs('#btnPause').disabled=true; }
 function reset(){ pause(); elapsed=0; document.getElementById('clock').textContent='00:00.0'; qs('#btnReset').disabled=true; session.laps=0; session.shots=[]; session.frac=0; renderLaps(); renderShots(); hideEnd(); }
 function tick(){ elapsed=Date.now()-t0; const cs=Math.floor(elapsed/100); const m=Math.floor(cs/600), s=Math.floor((cs%600)/10), d=cs%10; document.getElementById('clock').textContent=`${m<10?'0':''}${m}:${s<10?'0':''}${s}.${d}`; if(m>=session.dureeMin){ pause(); showEnd(); } }
 qs('#btnStartCourse').onclick=start; qs('#btnPause').onclick=pause; qs('#btnReset').onclick=reset;

 // === Overlay fin obligatoire ===
 const endOverlay = document.getElementById('endOverlay');
 const distanceOutOverlay = document.getElementById('distanceOutOverlay');
 function updateDistanceOutputOverlay(){
   const meters=Math.round((session.laps+(session.frac||0))*session.tourM);
   distanceOutOverlay.textContent = `Distance: ${meters} m (${session.laps} tours + ${session.frac||0} tour)`;
 }

 function showEnd(){
   endCard.classList.add('hidden');
   session.frac = session.frac || 0;
   updateDistanceOutputOverlay();
   courseCard.classList.add('lock');
   endOverlay.classList.add('show');
   if(navigator.vibrate) navigator.vibrate(150);
 }
 function hideEnd(){
   endCard.classList.add('hidden');
   endOverlay.classList.remove('show');
   courseCard.classList.remove('lock');
 }

 document.querySelectorAll('[data-frac-overlay]').forEach(b=>{
   b.onclick=()=>{ if(session.finished) return; session.frac=+b.getAttribute('data-frac-overlay'); updateDistanceOutputOverlay(); };
 });
 document.getElementById('finishRunnerOverlay').onclick=()=> finalizeRunner();

 // (panneau bas conserv√© mais non utilis√©)
 endCard.querySelectorAll('[data-frac]').forEach(b=> b.onclick=()=>{ if(session.finished) return; session.frac=+b.getAttribute('data-frac'); updateDistanceOutput(); });
 qs('#finishRunner').onclick=()=> finalizeRunner();

 function updateDistanceOutput(){
   const meters=Math.round((session.laps+(session.frac||0))*session.tourM);
   distanceOut.textContent=`Distance: ${meters} m (${session.laps} tours + ${session.frac||0} tour)`;
 }
 function renderLaps(){
   document.getElementById('laps').textContent=session.laps;
   liveDistanceEl.textContent = Math.round((session.laps+(session.frac||0))*session.tourM);
   updateDistanceOutput();
   updateDistanceOutputOverlay();
 }

 function addShot(leds){
   const n=session.shots.length+1;
   session.shots.push({n,leds});
   renderShots();
 }
 function renderShots(){
   shotsTable.innerHTML='';
   // ORDRE INVERSE : dernier tir en premier
   [...session.shots].reverse().forEach(s=>{
     const tr=document.createElement('tr');
     tr.innerHTML=`<td>${s.n}</td><td>${s.leds}</td><td><button class="b-red">Retirer</button></td>`;
     tr.querySelector('button').onclick=()=>{ if(session.finished) return; session.shots=session.shots.filter(x=>x.n!==s.n).map((x,i)=>({n:i+1,leds:x.leds})); renderShots(); };
     shotsTable.append(tr);
   });
   renderCounts();
 }
 function renderCounts(){
   const c={0:0,1:0,2:0,3:0,4:0,5:0};
   session.shots.forEach(s=>{ if(c.hasOwnProperty(s.leds)) c[s.leds]++; });
   qs('#liveCounts').innerHTML =
     `<span class="pill">Nb LED 5 : <b>${c[5]}</b></span>
      <span class="pill">Nb LED 4 : <b>${c[4]}</b></span>
      <span class="pill">Nb LED 3 : <b>${c[3]}</b></span>
      <span class="pill">Nb LED 2 : <b>${c[2]}</b></span>
      <span class="pill">Nb LED 1 : <b>${c[1]}</b></span>
      <span class="pill">Nb LED 0 : <b>${c[0]}</b></span>`;
 }

 function switchRunner(which){
   if(session.finished) return;
   saveTemp();
   session.active=which;
   reset();
   resetRunnerState();
   paintCourseHeader();
   loadTemp();
 }
 function resetRunnerState(){ session.laps=0; session.shots=[]; session.frac=0; renderLaps(); renderShots(); hideEnd(); }
 function paintCourseHeader(){
   const R=session[session.active];
   document.getElementById('runnerTitle').textContent=`Coureur ‚Äî ${R.prenom} ${R.nom}`;
   document.getElementById('courseMeta').textContent=`${R.classe} ‚Ä¢ ${R.sexe}`;
   document.getElementById('lapMeters').textContent=session.tourM;
   document.getElementById('target').textContent=session.dureeMin;
 }

 const temp={ p1:{laps:0,frac:0,shots:[]}, p2:{laps:0,frac:0,shots:[]} };
 function saveTemp(){ temp[session.active]={ laps:session.laps, frac:session.frac, shots:JSON.parse(JSON.stringify(session.shots)) }; }
 function loadTemp(){ const t=temp[session.active]; session.laps=t.laps; session.frac=t.frac; session.shots=JSON.parse(JSON.stringify(t.shots)); renderLaps(); renderShots(); hideEnd(); }

 function countShotsArray(arr){ const c={0:0,1:0,2:0,3:0,4:0,5:0}; arr.forEach(v=>{ if(c.hasOwnProperty(v)) c[v]++; }); return c; }

 // ===== Indice Tir (base + bonus perfection b=0.10) =====
 function computeIndiceFromCounts(counts){
   const T = counts[0]+counts[1]+counts[2]+counts[3]+counts[4]+counts[5];
   if(!T) return {indice:0, niveau:'‚Äî'};
   const totalLed = 0*counts[0] + 1*counts[1] + 2*counts[2] + 3*counts[3] + 4*counts[4] + 5*counts[5];
   const base = (totalLed / (5*T)) * 100; // 0..100
   const b = 0.10; // bonus 10%
   const bonus = b * (counts[5]/T) * 100; // 0..10
   const indice = +(base + bonus).toFixed(2);
   let niveau = '√† travailler üî¥';
   if(indice>=80) niveau='excellent ‚úÖ'; else if(indice>=60) niveau='bon üëç'; else if(indice>=40) niveau='en progr√®s üü®';
   return {indice, niveau};
 }

 // === NOUVEAU : payload QR all√©g√© (sans emoji), ajoute indice_perf num√©rique ===
 function buildQrData(dataRows){
   return dataRows.map(d => ({
     nom: d.nom,
     prenom: d.prenom,
     classe: d.classe,
     sexe: d.sexe,
     distance: d.distance,
     vitesse: d.vitesse,
     nb_led_0: d.nb_led_0,
     nb_led_1: d.nb_led_1,
     nb_led_2: d.nb_led_2,
     nb_led_3: d.nb_led_3,
     nb_led_4: d.nb_led_4,
     nb_led_5: d.nb_led_5,
     indice_perf: d.indice_tir // num√©rique, sans emoji
   }));
 }

 function finalizeRunner(){
   const R=session[session.active];
   const meters=Math.round((session.laps+(session.frac||0))*session.tourM);
   const vitesse=+(meters*60/(1000*session.dureeMin)).toFixed(2); // km/h
   const counts=countShotsArray(session.shots.map(s=>s.leds));
   const ind = computeIndiceFromCounts(counts);
   session.results[session.active]={ prenom:R.prenom, nom:R.nom, classe:R.classe, sexe:R.sexe,
     distance:meters, vitesse:vitesse,
     nb_led_0:counts[0], nb_led_1:counts[1], nb_led_2:counts[2], nb_led_3:counts[3], nb_led_4:counts[4], nb_led_5:counts[5],
     indice_tir: ind.indice, niveau_tir: ind.niveau
   };

   hideEnd();
   document.getElementById('courseCard').classList.add('lock');
   setTimeout(()=> document.getElementById('courseCard').classList.remove('lock'), 300);

   const other=session.active==='p1'?'p2':'p1';
   if(!session.results[other]){
     alert('Course du coureur termin√©e.\nPassez au second coureur.');
     switchRunner(other);
     return;
   }

   session.finished=true;
   document.getElementById('pickP1').disabled=true;
   document.getElementById('pickP2').disabled=true;
   toSummaryWrap.classList.remove('hidden');
 }

 // ===== Bilan / QR + MODE PROF =====
 const backToCourseBtn=qs('#backToCourse'); const backHome2Btn=qs('#backHome2'); const goSummaryBtn=qs('#goSummary');

 // Donn√©es affich√©es dans le bilan (persist√©es pour √©dition)
 let summaryData = [];
 let profMode = false;

 function buildQR(payload){
   const qrBox=document.getElementById('qr');
   qrBox.innerHTML='';
   try{ new QRCode(qrBox,{ text:payload, width:256, height:256, correctLevel:QRCode.CorrectLevel.M }); }
   catch(e){ console.warn('QR non g√©n√©r√©:', e); }
 }

 function toCSV(data) {
   const headers = [
     'nom','prenom','classe','sexe','distance','vitesse',
     'nb_led_0','nb_led_1','nb_led_2','nb_led_3','nb_led_4','nb_led_5',
     'indice_tir','niveau_tir'
   ];
   const esc = (v) => {
     const s = (v==null ? '' : String(v));
     if (/[;\"\n]/.test(s)) return `"${s.replace(/\"/g,'""')}"`;
     return s;
   };
   const lines = [
     headers.join(';'),
     ...data.map(d => headers.map(h => esc(d[h])).join(';'))
   ];
   return lines.join('\n');
 }

 function renderSummary(){
   // table (editable si profMode) ‚Äî Indice & Niveau affich√©s (non √©ditables)
   const rows = summaryData.map((d,i) => `
     <tr data-index="${i}">
       <td data-field="nom" ${profMode?'contenteditable="true"':''}>${d.nom}</td>
       <td data-field="prenom" ${profMode?'contenteditable="true"':''}>${d.prenom}</td>
       <td data-field="classe" ${profMode?'contenteditable="true"':''}>${d.classe}</td>
       <td data-field="sexe" ${profMode?'contenteditable="true"':''}>${d.sexe}</td>
       <td data-field="distance" ${profMode?'contenteditable="true"':''}>${d.distance}</td>
       <td data-field="vitesse" ${profMode?'contenteditable="true"':''}>${d.vitesse}</td>
       <td data-field="nb_led_0" ${profMode?'contenteditable="true"':''}>${d.nb_led_0}</td>
       <td data-field="nb_led_1" ${profMode?'contenteditable="true"':''}>${d.nb_led_1}</td>
       <td data-field="nb_led_2" ${profMode?'contenteditable="true"':''}>${d.nb_led_2}</td>
       <td data-field="nb_led_3" ${profMode?'contenteditable="true"':''}>${d.nb_led_3}</td>
       <td data-field="nb_led_4" ${profMode?'contenteditable="true"':''}>${d.nb_led_4}</td>
       <td data-field="nb_led_5" ${profMode?'contenteditable="true"':''}>${d.nb_led_5}</td>
       <td>${d.indice_tir}</td>
       <td>${d.niveau_tir}</td>
     </tr>
   `).join('');
   document.getElementById('resume').innerHTML = `
     <table id="summaryTable" ${profMode?'class="prof-on"':''}>
       <thead>
         <tr>
           <th>Nom</th><th>Pr√©nom</th><th>Classe</th><th>Sexe</th>
           <th>Distance (m)</th><th>Vitesse (km/h)</th>
           <th>Nb LED 0</th><th>Nb LED 1</th><th>Nb LED 2</th><th>Nb LED 3</th><th>Nb LED 4</th><th>Nb LED 5</th>
           <th>Indice tir</th><th>Niveau</th>
         </tr>
       </thead>
       <tbody id="resumeBody">${rows}</tbody>
     </table>`;

   // === QR (payload all√©g√©) : historique + indice_perf (num√©rique, sans emoji)
   const payloadQR = JSON.stringify(buildQrData(summaryData));
   buildQR(payloadQR);

   // CSV bouton (utilise summaryData courant)
   const exportBtn = document.getElementById('exportCsv');
   exportBtn.onclick = () => {
     const csv = toCSV(summaryData);
     const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
     const url = URL.createObjectURL(blob);
     const a = document.createElement('a');
     const fileDate = new Date().toISOString().slice(0,10);
     a.href = url; a.download = `LaserRun_${fileDate}.csv`;
     document.body.appendChild(a); a.click(); document.body.removeChild(a);
     URL.revokeObjectURL(url);
   };

   // Boutons prof
   const profHint = document.getElementById('profHint');
   const act = document.getElementById('activateProf');
   const deact = document.getElementById('deactivateProf');
   const apply = document.getElementById('applyEdits');
   act.disabled = profMode;
   deact.disabled = !profMode;
   apply.disabled = !profMode;
   profHint.textContent = profMode
     ? 'Mode Prof activ√© : corrigez puis ‚ÄúMettre √† jour QR/CSV‚Äù. L\'indice est recalcul√© automatiquement.'
     : 'Saisir le code 57 pour corriger une valeur (distance, LED, etc.).';
 }

 function parseEditsFromTable(){
   const tbody = document.getElementById('resumeBody');
   const rows = Array.from(tbody.querySelectorAll('tr'));
   const next = rows.map(tr=>{
     function txt(field){ return (tr.querySelector(`[data-field="${field}"]`)?.textContent||'').trim(); }
     const sexeRaw = (txt('sexe')||'').toUpperCase();
     const sexe = (sexeRaw==='F' || sexeRaw==='M') ? sexeRaw : 'F';
     function num(field, def=0){ const v=Number((txt(field)||'').replace(',', '.')); return Number.isFinite(v) ? v : def; }
     function int(field, def=0){ const v=parseInt(txt(field),10); return Number.isFinite(v)? Math.max(0,v) : def; }

     const counts = {
       0:int('nb_led_0'), 1:int('nb_led_1'), 2:int('nb_led_2'),
       3:int('nb_led_3'), 4:int('nb_led_4'), 5:int('nb_led_5')
     };
     const ind = computeIndiceFromCounts(counts);

     return {
       nom: txt('nom'),
       prenom: txt('prenom'),
       classe: txt('classe'),
       sexe,
       distance: int('distance'),
       vitesse: Number(num('vitesse').toFixed(2)),
       nb_led_0: counts[0], nb_led_1: counts[1], nb_led_2: counts[2],
       nb_led_3: counts[3], nb_led_4: counts[4], nb_led_5: counts[5],
       indice_tir: ind.indice,
       niveau_tir: ind.niveau,
     };
   });
   return next;
 }

 // Activation mode Prof
 document.getElementById('activateProf').onclick = ()=>{
   const code = (document.getElementById('profCode').value||'').trim();
   if(code === '57'){
     profMode = true;
     renderSummary();
   }else{
     alert('Code incorrect.');
   }
 };
 document.getElementById('deactivateProf').onclick = ()=>{
   profMode = false;
   renderSummary();
 };
 document.getElementById('applyEdits').onclick = ()=>{
   if(!profMode) return;
   const updated = parseEditsFromTable();
   summaryData = updated;
   renderSummary();
   alert('Bilan mis √† jour. QR et CSV r√©g√©n√©r√©s.');
 };

 // Aller au bilan
 goSummaryBtn.onclick=()=>{
   const out=[];
   if(session.results.p1){ const r=session.results.p1; out.push({ nom:r.nom, prenom:r.prenom, classe:r.classe, sexe:r.sexe, distance:r.distance, vitesse:r.vitesse, nb_led_0:r.nb_led_0, nb_led_1:r.nb_led_1, nb_led_2:r.nb_led_2, nb_led_3:r.nb_led_3, nb_led_4:r.nb_led_4, nb_led_5:r.nb_led_5, indice_tir:r.indice_tir, niveau_tir:r.niveau_tir }); }
   if(session.results.p2){ const r=session.results.p2; out.push({ nom:r.nom, prenom:r.prenom, classe:r.classe, sexe:r.sexe, distance:r.distance, vitesse:r.vitesse, nb_led_0:r.nb_led_0, nb_led_1:r.nb_led_1, nb_led_2:r.nb_led_2, nb_led_3:r.nb_led_3, nb_led_4:r.nb_led_4, nb_led_5:r.nb_led_5, indice_tir:r.indice_tir, niveau_tir:r.niveau_tir }); }

   summaryData = out; // stocke pour √©dition
   show('summary');
   profMode = false; // par d√©faut verrouill√©
   renderSummary();
 };

 backToCourseBtn.onclick=()=> show('course');
 backHome2Btn.onclick=()=> { if(confirmLeaveIfNeeded()) show('cover'); };

 // ===== Initialisation =====
 validate();
 (function(){ console.assert(!!V.cover && !!V.duo && !!V.course && !!V.summary,'vues ok'); })();
 </script>
</body>
</html>
