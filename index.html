<!-- QRCode lib (CDN léger) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
'use strict';
// ===== helpers / navigation =====
function qs(sel){ return document.querySelector(sel); }
const V = {
  cover: qs('#view-cover'),
  duo: qs('#view-duo'),
  course: qs('#view-course'),
  summary: qs('#view-summary')
};
function show(name){
  Object.values(V).forEach(v=>v.classList.add('hidden'));
  V[name].classList.remove('hidden');
  window.scrollTo(0,0);
}
qs('#btnStart').onclick = ()=> show('duo');
qs('#btnHelp').onclick = ()=> alert('1) Démarrer → saisir les 2 élèves.\\n2) Accéder à la course : Start, +1 tour, tir.\\n3) À la fin : ajoutez 1/4, 1/2 ou 3/4 de tour.');
qs('#goHome').onclick = ()=> show('cover');

// ===== Validation stricte (empêche "J" puis champ suivant) =====
function clean(s){ return (s||'').replace(/\s+/g,' ').trim(); }
function minLen(s, n){ return clean(s).length >= n; }
function onlyLetters(s){ return /^[A-Za-zÀ-ÖØ-öø-ÿ\-\s']+$/.test(clean(s)); }
function val(id){ return clean(document.getElementById(id).value); }
function okNumber(v,min){ const n=+v; return Number.isFinite(n) && n>=min; }

function validateForm(){
  const fields = [
    {id:'p1_prenom', min:2, letters:true},
    {id:'p1_nom',    min:2, letters:true},
    {id:'p1_classe', min:2, letters:false},
    {id:'p1_sexe',   min:1, letters:false},
    {id:'p2_prenom', min:2, letters:true},
    {id:'p2_nom',    min:2, letters:true},
    {id:'p2_classe', min:2, letters:false},
    {id:'p2_sexe',   min:1, letters:false},
  ];
  let ok = true, firstBad=null;
  fields.forEach(f=>{
    const el = document.getElementById(f.id);
    const v = val(f.id);
    let good = minLen(v, f.min);
    if(f.letters) good = good && onlyLetters(v);
    el.style.borderColor = good ? '#e5e7eb' : '#ef4444';
    if(!good && !firstBad) firstBad = el;
    ok = ok && good;
  });
  const okDur = okNumber(val('duree_min'),1);
  const okTour = okNumber(val('tour_m'),10);
  document.getElementById('duree_min').style.borderColor = okDur ? '#e5e7eb' : '#ef4444';
  document.getElementById('tour_m').style.borderColor = okTour ? '#e5e7eb' : '#ef4444';
  ok = ok && okDur && okTour;
  qs('#goCourse').disabled = !ok;
  return ok;
}
// live validation
['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe','duree_min','tour_m']
  .forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input', validateForm);
    el.addEventListener('change', validateForm);
  });

const session = {
  p1:null, p2:null, tourM:0, dureeMin:0,
  active:'p1', laps:0, shots:[], frac:0,
  finished:false
};

qs('#goCourse').onclick = ()=>{
  if(!validateForm()){
    alert('Champs incomplets : prénoms/noms ≥ 2 lettres (lettres/accents autorisés), durée et longueur en chiffres.');
    return;
  }
  session.p1 = { prenom:val('p1_prenom'), nom:val('p1_nom'), classe:val('p1_classe'), sexe:val('p1_sexe') };
  session.p2 = { prenom:val('p2_prenom'), nom:val('p2_nom'), classe:val('p2_classe'), sexe:val('p2_sexe') };
  session.dureeMin = +val('duree_min');
  session.tourM = +val('tour_m');
  session.active = 'p1';
  resetRunnerState();
  paintCourseHeader();
  show('course');
};

// ===== Course =====
const clockEl = document.getElementById('clock');
const lapsEl = document.getElementById('laps');
const lapMetersEl = document.getElementById('lapMeters');
const targetEl = document.getElementById('target');
const shotsTable = document.getElementById('shotsTable');
const runnerTitle = document.getElementById('runnerTitle');
const courseMeta = document.getElementById('courseMeta');
const endCard = document.getElementById('endCard');
const distanceOut = document.getElementById('distanceOut');
const courseCard = document.getElementById('courseCard');
const toSummaryWrap = document.getElementById('toSummaryWrap');

document.getElementById('pickP1').onclick = ()=> switchRunner('p1');
document.getElementById('pickP2').onclick = ()=> switchRunner('p2');
document.getElementById('lapPlus').onclick = ()=>{ if(session.finished) return; session.laps++; renderLaps(); };
document.getElementById('lapMinus').onclick = ()=>{ if(session.finished) return; session.laps = Math.max(0, session.laps-1); renderLaps(); };
document.getElementById('addShot').onclick = ()=>{ if(session.finished) return; addShot(); };
document.getElementById('backToDuo').onclick = ()=> show('duo');

let t0=0, elapsed=0, timer=null, running=false;
function start(){
  if(session.finished) return;
  if(running) return;
  running=true; t0=Date.now()-elapsed; timer=setInterval(tick,100);
  document.getElementById('btnStartCourse').disabled=true;
  document.getElementById('btnPause').disabled=false;
  document.getElementById('btnReset').disabled=false;
}
function pause(){
  if(!running) return;
  running=false; clearInterval(timer);
  document.getElementById('btnStartCourse').disabled=false;
  document.getElementById('btnPause').disabled=true;
}
function reset(){
  pause(); elapsed=0; clockEl.textContent='00:00.0';
  document.getElementById('btnReset').disabled=true;
  session.laps=0; session.shots=[]; session.frac=0;
  renderLaps(); renderShots(); hideEnd();
}
function tick(){
  elapsed = Date.now()-t0;
  const cs=Math.floor(elapsed/100);
  const m=Math.floor(cs/600), s=Math.floor((cs%600)/10), d=cs%10;
  clockEl.textContent = `${m<10?'0':''}${m}:${s<10?'0':''}${s}.${d}`;
  if(m>=session.dureeMin){ pause(); showEnd(); }
}
document.getElementById('btnStartCourse').onclick = start;
document.getElementById('btnPause').onclick = pause;
document.getElementById('btnReset').onclick = reset;

function showEnd(){ endCard.classList.remove('hidden'); updateDistanceOutput(); }
function hideEnd(){ endCard.classList.add('hidden'); }

endCard.querySelectorAll('[data-frac]').forEach(b=>
  b.onclick = ()=>{ if(session.finished) return; session.frac = +b.getAttribute('data-frac'); updateDistanceOutput(); }
);
document.getElementById('finishRunner').onclick = ()=>{ finalizeRace(); };

function updateDistanceOutput(){
  const meters = Math.round((session.laps + (session.frac||0)) * session.tourM);
  distanceOut.textContent = `Distance: ${meters} m (${session.laps} tours + ${session.frac||0} tour)`;
}

function addShot(){
  const n = session.shots.length+1;
  const leds = +document.getElementById('ledSelect').value;
  session.shots.push({n, leds}); renderShots();
}
function renderShots(){
  shotsTable.innerHTML='';
  session.shots.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.n}</td><td>${s.leds}</td><td><button class="b-red">Retirer</button></td>`;
    tr.querySelector('button').onclick = ()=>{
      if(session.finished) return;
      session.shots = session.shots.filter(x=>x.n!==s.n);
      session.shots = session.shots.map((x,i)=> ({n:i+1, leds:x.leds}));
      renderShots();
    };
    shotsTable.append(tr);
  });
}

function renderLaps(){ lapsEl.textContent = session.laps; updateDistanceOutput(); }

function switchRunner(which){
  if(session.finished) return;
  session.active = which;
  reset(); resetRunnerState(); paintCourseHeader();
}
function resetRunnerState(){ session.laps=0; session.shots=[]; session.frac=0; renderLaps(); renderShots(); hideEnd(); }
function paintCourseHeader(){
  const R = session[session.active];
  runnerTitle.textContent = `Coureur — ${R.prenom} ${R.nom}`;
  courseMeta.textContent = `${R.classe} • ${R.sexe}`;
  lapMetersEl.textContent = session.tourM;
  targetEl.textContent = session.dureeMin;
}

function finalizeRace(){
  session.finished = true;
  // Verrouille toutes les interactions de la page course
  document.getElementById('courseCard').classList.add('lock');
  document.getElementById('pickP1').disabled = true;
  document.getElementById('pickP2').disabled = true;
  toSummaryWrap.classList.remove('hidden'); // bouton Aller au bilan
}

// ===== Bilan / QR =====
const backToCourseBtn = document.getElementById('backToCourse');
const backHome2Btn = document.getElementById('backHome2');
const goSummaryBtn = document.getElementById('goSummary');

goSummaryBtn.onclick = ()=>{
  const R = session[session.active];
  const meters = Math.round((session.laps + (session.frac||0)) * session.tourM);
  // Format simple CSV (à ajuster si ScanProf attend un format strict) :
  // LASERRUN;prenom;nom;classe;sexe;duree_min;tour_m;laps;frac;distance;shots(leds-...)
  const shots = session.shots.map(s=>s.leds).join('-');
  const payload = [
    'LASERRUN', R.prenom, R.nom, R.classe, R.sexe,
    session.dureeMin, session.tourM, session.laps, session.frac||0, meters, shots
  ].join(';');

  show('summary');

  // QR
  const qrBox = document.getElementById('qr');
  qrBox.innerHTML = '';
  try {
    new QRCode(qrBox, { text: payload, width: 256, height: 256, correctLevel: QRCode.CorrectLevel.M });
    document.getElementById('qrText').textContent = payload;
  } catch(e){
    document.getElementById('qrText').textContent = 'QR indisponible — contenu: '+payload;
  }
};

backToCourseBtn.onclick = ()=> show('course');
backHome2Btn.onclick = ()=> show('cover');

// Initial
validateForm();
</script>
